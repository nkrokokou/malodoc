generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  PATIENT
  PROFESSIONAL
  PHARMACY
  ADMIN
}

enum AppointmentStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
  NO_SHOW
}

enum DonationStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum MedicineStatus {
  AVAILABLE
  OUT_OF_STOCK
  LOW_STOCK
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

// Models
model User {
  id         String   @id @default(uuid())
  email      String   @unique
  phone      String   @unique
  password   String
  role       UserRole @default(PATIENT)
  firstName  String
  lastName   String
  isVerified Boolean  @default(false)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  patientProfile      PatientProfile?
  professionalProfile ProfessionalProfile?
  pharmacyProfile     PharmacyProfile?
  appointments        Appointment[]
  donations           Donation[]
  notifications       Notification[]

  @@index([email])
  @@index([phone])
}

model PatientProfile {
  id               String    @id @default(uuid())
  userId           String    @unique
  dateOfBirth      DateTime?
  gender           Gender?
  address          String?
  city             String?
  country          String    @default("Togo")
  latitude         Float?
  longitude        Float?
  bloodType        String?
  allergies        String?   @db.Text
  medicalHistory   String?   @db.Text
  emergencyContact String?
  emergencyPhone   String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProfessionalProfile {
  id                   String   @id @default(uuid())
  userId               String   @unique
  specialty            String
  licenseNumber        String   @unique
  isVerified           Boolean  @default(false)
  clinicName           String?
  clinicAddress        String
  city                 String
  country              String   @default("Togo")
  latitude             Float
  longitude            Float
  consultationFee      Float    @default(0)
  bio                  String?  @db.Text
  yearsOfExperience    Int      @default(0)
  languages            String?  @db.Text
  workingHours         String?  @db.Text
  hasSolidaritySlots   Boolean  @default(false)
  solidarityPercentage Float    @default(0)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  user           User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments   Appointment[]
  availabilities Availability[]
  reviews        Review[]
}

model PharmacyProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  pharmacyName  String
  licenseNumber String   @unique
  isVerified    Boolean  @default(false)
  address       String
  city          String
  country       String   @default("Togo")
  latitude      Float
  longitude     Float
  phone         String
  openingHours  String?  @db.Text
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  medicines     Medicine[]
  prescriptions Prescription[]
}

model Availability {
  id             String   @id @default(uuid())
  professionalId String
  date           DateTime
  startTime      String
  endTime        String
  isBooked       Boolean  @default(false)
  isSolidarity   Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  professional ProfessionalProfile @relation(fields: [professionalId], references: [id], onDelete: Cascade)
  appointment  Appointment?

  @@index([professionalId, date])
  @@index([isSolidarity])
}

model Appointment {
  id             String            @id @default(uuid())
  patientId      String
  professionalId String
  availabilityId String            @unique
  status         AppointmentStatus @default(PENDING)
  reason         String?
  notes          String?           @db.Text
  isSolidarity   Boolean           @default(false)
  isPaid         Boolean           @default(false)
  amount         Float             @default(0)
  reminderSent   Boolean           @default(false)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  patient      User                @relation(fields: [patientId], references: [id])
  professional ProfessionalProfile @relation(fields: [professionalId], references: [id])
  availability Availability        @relation(fields: [availabilityId], references: [id])
  prescription Prescription?
  review       Review?

  @@index([patientId])
  @@index([professionalId])
  @@index([status])
}

model Prescription {
  id            String   @id @default(uuid())
  appointmentId String   @unique
  pharmacyId    String?
  medications   String   @db.Text
  diagnosis     String?  @db.Text
  notes         String?  @db.Text
  fileUrl       String?
  isProcessed   Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  appointment Appointment      @relation(fields: [appointmentId], references: [id])
  pharmacy    PharmacyProfile? @relation(fields: [pharmacyId], references: [id])

  @@index([pharmacyId])
}

model Review {
  id             String   @id @default(uuid())
  appointmentId  String   @unique
  professionalId String
  rating         Int
  comment        String?  @db.Text
  createdAt      DateTime @default(now())

  appointment  Appointment         @relation(fields: [appointmentId], references: [id], onDelete: Cascade)
  professional ProfessionalProfile @relation(fields: [professionalId], references: [id])

  @@index([professionalId])
}

model Medicine {
  id           String         @id @default(uuid())
  pharmacyId   String
  name         String
  genericName  String?
  description  String?        @db.Text
  category     String
  price        Float
  status       MedicineStatus @default(AVAILABLE)
  quantity     Int            @default(0)
  isSolidarity Boolean        @default(false)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  pharmacy PharmacyProfile @relation(fields: [pharmacyId], references: [id], onDelete: Cascade)

  @@index([pharmacyId])
  @@index([name])
  @@index([isSolidarity])
}

model Donation {
  id                  String         @id @default(uuid())
  userId              String?
  amount              Float
  currency            String         @default("XOF")
  status              DonationStatus @default(PENDING)
  paymentMethod       String
  paymentProvider     String?
  transactionId       String?
  donorName           String?
  donorEmail          String?
  donorPhone          String?
  isAnonymous         Boolean        @default(false)
  message             String?        @db.Text
  usedForAppointments Int            @default(0)
  createdAt           DateTime       @default(now())
  updatedAt           DateTime       @updatedAt

  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Notification {
  id        String   @id @default(uuid())
  userId    String
  type      String
  title     String
  message   String   @db.Text
  isRead    Boolean  @default(false)
  isSent    Boolean  @default(false)
  relatedId String?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, isRead])
}

model SystemStats {
  id                          String   @id @default(uuid())
  totalUsers                  Int      @default(0)
  totalPatients               Int      @default(0)
  totalProfessionals          Int      @default(0)
  totalPharmacies             Int      @default(0)
  totalAppointments           Int      @default(0)
  totalSolidarityAppointments Int      @default(0)
  totalDonations              Float    @default(0)
  donationsUsed               Float    @default(0)
  lastUpdated                 DateTime @default(now())

  @@index([lastUpdated])
}
